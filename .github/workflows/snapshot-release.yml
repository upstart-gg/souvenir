name: Snapshot Release

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  snapshot-release:
    if: github.repository == 'upstart-gg/souvenir' && github.event.pull_request.merged == true && !startsWith(github.event.pull_request.title, 'chore(release):')
    name: Snapshot Release
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: ".tool-versions"

      - name: Creating .npmrc
        run: |
          cat << EOF > "$HOME/.npmrc"
            //registry.npmjs.org/:_authToken=$NPM_TOKEN
          EOF
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: ".tool-versions"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build packages
        run: bun run build

      - name: Publish Snapshot
        run: bunx changeset publish --tag next >> $GITHUB_STEP_SUMMARY
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Parse output
        id: parse_published_packages
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync(process.env.GITHUB_STEP_SUMMARY, 'utf8');
            const packages = Array.from(
              output.matchAll(/Publishing \"([^\"]+)\" at \"([^\"]+)\"/gm), m => ({ package: m[1], version: m[2] })
            );
            console.log('Published:', JSON.stringify(packages, null, 2));
            let body = '';
            (packages || []).forEach(({ package, version }) => { body += `- ${package}@${version}\n`; });
            return packages.length > 0 ? { packages, body } : null;
